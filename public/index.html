<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Epub Reader</title>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&display=swap");

        body {
            padding: 0 30px 0 30px;
            background: #191A1CFF;
            color: white;
            font-family: 'Open Sans', sans-serif;
        }

        .a, a {
            color: #2599e7;
            text-decoration-color: rgba(0, 0, 0, 0);
            transition: all ease-in-out 100ms;
            cursor: pointer;
        }

        .a:hover, a:hover {
            text-decoration-color: #2599e7;
        }

        a:visited:hover {
            text-decoration-color: lightblue;
        }

        a:visited {
            color: lightblue;
        }

        p {
            margin: 10px 0 10px 0;
        }

        #list {
            margin-bottom: 30px;
        }

        #nolist {
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            text-align: center;
            background: white;
            color: black;
        }
    </style>
    <script src="socket.io.js"></script>
</head>
<body>
<div id="nolist" style="display: none">Running in nolist mode. <span class="a"
                                                                     onclick="window.location.search = ''">Get a list</span>
    or <span class="a" onclick="document.querySelector('#nolist').style.display = 'none';">hide this message</span>
</div>
<div>
    <form action="upload" enctype="multipart/form-data" method="post">>
        <label for="file">Choose a file to upload: </label>
        <input
                accept="application/epub+zip,application/pdf"
                id="file"
                name="file"
                type="file">
        <input type="submit" value="Upload">
    </form>
</div>
<div id="list"></div>
<div id="book"></div>
<script>
    function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) === 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    function getBook(o) {
        return () => {
            socket.emit("parse", o);
        }
    }

    let socket = io();
    socket.on("connect", () => {
        if (getCookie("key") !== "") {
            socket.emit("key", getCookie("key"));
        } else {
            if (confirm("Login?")) socket.emit("username", prompt("Enter username:"));
            else {
                let params = new URL(window.location.href).searchParams;
                if (!(params.has("nolist"))) socket.emit("list", {});
                else document.querySelector("#nolist").style.display = "block";
                if (window.location.hash !== "") {
                    getBook(decodeURIComponent(window.location.hash.replace("#", "")))();
                }
            }
        }
    });

    socket.on("key_invalid", () => {
        if (confirm("Login?")) socket.emit("username", prompt("Enter username:"));
        else {
            let params = new URL(window.location.href).searchParams;
            if (!(params.has("nolist"))) socket.emit("list", {});
            else document.querySelector("#nolist").style.display = "block";
            if (window.location.hash !== "") {
                getBook(decodeURIComponent(window.location.hash.replace("#", "")))();
            }
        }
    });
    socket.on("key_valid", () => {
        let params = new URL(window.location.href).searchParams;
        if (!(params.has("nolist"))) socket.emit("list", {});
        else document.querySelector("#nolist").style.display = "block";
        if (window.location.hash !== "") {
            getBook(decodeURIComponent(window.location.hash.replace("#", "")))();
        }
    });
    socket.on("invalid_auth", () => {
        socket.emit("username", prompt("Enter username:"));
    });
    socket.on("valid_username", () => {
        socket.emit("password", prompt("Enter password:"));
    });
    socket.on("valid_password", (key) => {
        document.cookie = `key=${key.key}; expires=${new Date(key.expires)}`;
        let params = new URL(window.location.href).searchParams;
        if (!(params.has("nolist"))) socket.emit("list", {});
        else document.querySelector("#nolist").style.display = "block";
        if (window.location.hash !== "") {
            getBook(decodeURIComponent(window.location.hash.replace("#", "")))();
        }
    });
    socket.on("list", (list) => {
        document.querySelector("#nolist").style.display = "none";
        document.querySelector("#list").innerHTML = "";
        for (let o of list) {
            let nameLinkEl = document.createElement("a");
            let creatorLinkEl = document.createElement("span");
            let containerEl = document.createElement("div");
            let pel1 = document.createElement("span");
            let pel2 = document.createElement("span");
            pel1.innerText = " by ";
            pel2.innerText = ` [${o.book}]`;
            pel2.style.color = "#aaffaa";

            nameLinkEl.href = `#${o.book}`;
            nameLinkEl.onclick = getBook(o.book);
            nameLinkEl.innerText = o.title;

            creatorLinkEl.classList.add("a");
            creatorLinkEl.style.cursor = "auto";
            creatorLinkEl.innerText = o.creator;

            containerEl.appendChild(nameLinkEl);
            containerEl.appendChild(pel1)
            containerEl.appendChild(creatorLinkEl);
            containerEl.appendChild(pel2);
            document.querySelector("#list").appendChild(containerEl);
        }
    });
    socket.on("results", result => {
        totalChapters = result.results.contentChapters.length;
        document.querySelector("#book").innerHTML = "";
        let titleEl = document.createElement("h1");
        titleEl.textContent = result.results.metadata.title;
        document.querySelector("#book").appendChild(titleEl);
        for (let i = result.results.contentChapters.length - 3; i > -1; i--) {
            let chapter = result.results.contentChapters[i];
            if (chapter === 0) {
                chapter = result.results.rawChapters[i];
                let h2ttl = document.createElement("h2");
                h2ttl.innerText = `Chapter ${chapter.loc - 1} (RAW)`;
                document.querySelector("#book").appendChild(h2ttl);
                continue;
            }
            let h2ttl = document.createElement("h2");
            let el = document.createElement("div");
            h2ttl.innerText = `Chapter ${chapter.loc - 1}: ${chapter.title}`;
            document.querySelector("#book").appendChild(h2ttl);
            el.innerHTML = chapter.content;
            document.querySelector("#book").appendChild(el);
            // for (const content of chapter.content) {
            //     let el = document.createElement("p");
            //     el.innerText = content;
            //     document.querySelector("#book").appendChild(el);
            // }
        }
    });
    socket.on("pdf", res => {
        let {basename, key} = res;
        document.querySelector("#book").innerHTML = "";

        let url = new URL(window.location.href);
        url.searchParams.set("name", basename);
        url.searchParams.set("key", key);
        url.pathname = "/pdf";
        url.hash = "";

        let iframe = document.createElement("iframe");
        iframe.src = url.href;
        iframe.width = window.innerWidth - 80;
        iframe.height = iframe.width * Math.SQRT2;

        document.querySelector("#book").appendChild(iframe);
    })
</script>
</body>
</html>
